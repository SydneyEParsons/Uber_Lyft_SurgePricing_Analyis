---
title: RTMB (Template Model Builder in R)
format:
    revealjs:
        theme: [white, ../custom.scss]
        smaller: true
        scrollable: true
        slide-number: true
        self-contained: true
---

## What is RTMB

- RTMB is an R package that helps you perform maximum likelihood inference for
    customized statistical models, including those with random effects.
- Non-standard models in R
    - Models you can't easily fit into an existing GLMM R function
    - Complex non-linear dynamics
    - Complicated correlations in your data
    - Multiple related response variables
- Some data will be well-suited to existing packages and functions such as
    the `lm`, `glm`, `lmer`, and `glmer` functions we've used.
    Other datasets will need models you can't easily fit using those functions.

## GLMM Likelihood

- Joint likelihood function:
$$
    L_{\text{joint}}\left(\theta,~w\right) =
        \prod_{i=1}^{n} f_{\text{Y}}\left(y_{i}; \theta, w\right) \cdot
        \prod_{f=1}^{F} f_{\text{N}}\left(w_{f}; \theta\right)
$$

- Marginal likelihood:
$$
    L_{\text{marg}}\left(\theta\right) =
        \int 
            L_{\text{joint}}\left(\theta,~w\right)
        \cdot dw_{1}\dots dw_{f}
$$

- Tradiitional methods for fitting GLMMs use approximations to a least-squares
    estimator instead of using maximum likelihood because the marginal 
    likelihood is hard to compute.
- RTMB uses the Laplace approximation to quickly (and automatically) compute the
    marginal distribution.
    - The Laplace approximation essentially turns an integration problem into
        an optimization + differentiation problem.

## Optimization Methods

- We want to minimize the negative log-likelihood function to estimate $\theta$:
$$
    \hat{\theta} = \text{argmin}~-\text{log}~
        \text{L}_{\text{marg}}\left(\theta\right) =
        \text{argmin}~-\ell\left(\theta\right)
$$
- If the model is simple and only has a few parameters, e.g. only 4-5 regression
    parameters then you can use any method to find $\hat{\theta}$.
- If the models is any more complicated then we need efficient methods, such as
    a quasi-Newton minimizer aided by automatic differentiation.
    - A Newton minimizer is an iterative algorithm (like many we've seen).
    - Each iteration assume we can approximate $\ell\left(\theta\right)$ using 
        the...
        - *gradient*, the vector of first derivates of $\ell$ wrt $\theta$, and
        - *hessian*, the matrix of second derivates of $\ell$ wrt $\theta$.
    - Quasi-Newton minimizers approximate the hessian using the gradient.
- Automatic differentiation is a way of calculating the gradient *very* easily,
    but it is hard to implement so there aren't many other packages available.


## What is RTMB? (Part 2)

- RTMB is a package that...
    - converts joint negative log-likelihood functions into marginal negative
        log-likelihood functions using the Laplace approximation, and
    - computes the gradient of the marginal negative log-likelihood function
        using automatic differentiation

- In addition, RTMB gives you access to a few other very useful tools:
    - Standard errors for all model parameter estimates *and* random effects
        predictions.
    - Ability to retrieve "derived quantities" from your model with standard
        errors.
    - Easy simulation from the model.
    - Residuals for model validation.

## Installing RTMB

- Try installing via `install.packages("RTMB")` in R.
- If that doesn't work, go to the 
    [RTMB GitHub page](https://github.com/kaskr/RTMB) and follow the 
    instructions there.
- You might need to install developer tools...
    - Windows: [RTools](https://cran.r-project.org/bin/windows/Rtools/rtools44/rtools.html)
        - Make sure you get the version that corresponds to your version of R
    - MacOS: Install XCode from the App store or 
        [look here for instructions](https://cran.r-project.org/bin/macosx/tools/)
    - Linux: Install a C++ compiler and a fortran compiler.
- Also check out the long-form documentation for the RTMB package
    - [Introduction](https://kaskr.r-universe.dev/articles/RTMB/RTMB-introduction.html)
    - [Advanced Details](https://kaskr.r-universe.dev/articles/RTMB/RTMB-advanced.html)
    - [Reference Manual](https://kaskr.r-universe.dev/RTMB#reference)

