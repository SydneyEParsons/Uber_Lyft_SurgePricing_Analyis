"0","library(tidyverse)"
"0","library(lubridate)"
"0","library(mgcv)      # GAM"
"0",""
"0","cab <- read_csv(""cab_rides.csv"")"
"0","weather <- read_csv(""weather.csv"")"
"0",""
"0","# 1) timestamp：cab - ms，weather - s"
"0","# Convert timestamps to datetime + hour bins"
"0","cab2 <- cab %>%"
"0","  mutate("
"0","    dt = as_datetime(floor(time_stamp / 1000), tz = ""UTC""),"
"0","    hour_ts = floor_date(dt, unit = ""hour"")"
"0","  )"
"0",""
"0","weather2 <- weather %>%"
"0","  mutate("
"0","    dt = as_datetime(time_stamp, tz = ""UTC""),"
"0","    hour_ts = floor_date(dt, unit = ""hour"")"
"0","  )"
"0",""
"0","# 2) Aggregate weather within each hour"
"0","w_hour <- weather2 %>%"
"0","  group_by(hour_ts) %>%"
"0","  summarise("
"0","    across(c(temp, clouds, pressure, rain, humidity, wind),"
"0","           ~ mean(.x, na.rm = TRUE)),"
"0","    .groups = ""drop"""
"0","  )"
"0",""
"0","# 3) merge and clean"
"0","df <- cab2 %>%"
"0","  left_join(w_hour, by = ""hour_ts"") %>%"
"0","  filter(!is.na(price), price > 0, name != ""Taxi"") %>%"
"0","  mutate("
"0","    hour = hour(hour_ts),"
"0","    route = paste(source, destination, sep = "" -> "")"
"0","  )"
"0",""
"0","# plot 1：temp vs price"
"0","ggplot(df %>% sample_n(min(nrow(df), 50000)), aes(temp, price)) +"
"0","  geom_point(alpha = 0.05) +"
"0","  geom_smooth() +"
"0","  scale_y_log10()"
